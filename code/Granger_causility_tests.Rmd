---
title: "Granger Causality Tests of Zeit"
author: "Dirk Ulbricht"
date: "Monday, January 05, 2015"
output: html_document
---
```{r global_options,include=FALSE}
library(knitr)
opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/',
               warning=FALSE, message=FALSE)
```
### Description

This file establishes Granger causalities for the various Zeit indeces.

###  Main code

Setting directory and stuff
```{r}
DirCode='H:/git/zeit-2'
library("BMA", lib.loc="~/R/win-library/3.0")
dir.create(paste(DirCode,'/Results',sep=''))
DirRes=paste(DirCode,'/Results',sep='')
DirData=paste(DirCode,'/Data',sep='')
dir.create(paste(DirCode,'/Data',sep=''))
```
Restricting time to be considered 
```{r}

# df=df[grep('2001/01',row.names(df)):grep('2014/02',row.names(df)),]
```


Creating a function to get lags and setting lags to be tested.
```{r}

lagm<-function(x,nlag){
        # returns matrix with nlag of x
        nx=nrow(x)
        X=matrix(NA,nrow=nx,nlag)
        for (i in 2:(nlag+1)){
                X[i:nx,i-1]=x[1:(nx-i+1),1]
                }
        return(X)
        }
nlag=12
```
Setting target and group to be tested in Correlation and Granger Causality analysis
```{r}
group='zeit'
zeit.names=colnames(df)[grep(group,colnames(df))]
df=df.complete[,c('ip',zeit.names)]
df=df[complete.cases(df),]
nzeit=length(zeit.names)
target='ip'
dir.create(paste(DirRes,'/',target,sep=''))
DirTarget=paste(DirRes,'/',target,sep='')
```
correlation of target and lagged explanatory variables
```{r}
Correl=data.frame(matrix(NA,length(zeit.names),nlag*2))
row.names(Correl)=zeit.names
colnames(Correl)[1:nlag]=paste('lag',1:nlag,'coef',sep=' ')
colnames(Correl)[(nlag+1):(nlag*2)]=paste('lag',1:nlag,'p-val',sep=' ')
for (zeit.name in zeit.names){
        sdf=df[,zeit.name,drop=F]
        sdf=cbind(df[,target,drop=F],lagm(sdf[,1,drop=F],nlag))
        # eliminating lost observations due to lagging
        sdf=sdf[complete.cases(sdf),]
        for (i in 1:nlag){
                Correl[zeit.name,i]=cor.test(sdf[,1],sdf[,i+1])$estimate
                Correl[zeit.name,nlag+i]=cor.test(sdf[,1],sdf[,i+1])$p.value
                }
        
        }
Correl=round(Correl,2)
max.correl=data.frame(maximum=apply(Correl[,1:nlag],1,function(x) max(abs(x))))
max.correl[,'lag']=data.frame(maximum=apply(Correl[,1:nlag],1,function(x) which.max(abs(x))))
max.correl[,'p-val']=Correl[,max.correl[,'lag']+12] 
for (i in 1:nrow(Correl)){max.correl[i,'p-val']=Correl[i,max.correl[i,'lag']+12]}
for (i in 1:nrow(Correl)){print(Correl[i,max.correl[i,'lag']+12])}
max.correl.sign=max.correl[max.correl$'p-val'<=0.01,]
max.correl.sign=max.correl.sign[order(max.correl.sign$maximum,decreasing=T),]
write.csv(max.correl.sign,paste(DirTarget,'/correlated_models_',group,'.csv',sep=''))

```
Granger causality analysis
```{r}
# creating a list for collecting bicreg results
bicreg_res=vector("list", nzeit)
names(bicreg_res)=zeit.names
# creating a dataframe for collecting significant lags
df_res=data.frame(matrix(NA,nzeit,(nlag*2)))
row.names(df_res)=zeit.names

x1_ind=1:nlag
x2_ind=(nlag+1):(nlag*2)
colnames(df_res)[x1_ind]=paste(target,' by zeit',1:nlag,sep='')
colnames(df_res)[x2_ind]=paste('zeit by ',target,1:nlag,sep='')
# bayesian deterimination of significant lags and Granger Causality tests.

for (zeit.name in zeit.names){
        sdf=df[,c(target,zeit.name)]
        X_long=cbind(lagm(sdf[,1,drop=F],nlag),lagm(sdf[,2,drop=F],nlag))
        # eliminating lost observations due to lagging
        X=X_long[complete.cases(X_long),]
        # testing one way
        y1=sdf[(nlag+1):nrow(sdf),1]
        res1=bicreg(X,y1)
        bicreg_res[[zeit.name]]$y.is.target=res1
        df_res[zeit.name,x2_ind]=res1$which[1,x2_ind]
        # testing the other way
        y2=sdf[(nlag+1):nrow(sdf),2]
        res2=bicreg(X,y2)
        bicreg_res[[zeit.name]]$zeit.is.target=res2 
        df_res[zeit.name,x1_ind]=res2$which[1,x1_ind]
        }
write.csv(df_res,paste(DirTarget,'/Granger_causality_',group,'.csv',sep=''))
df_res=read.csv(paste(DirTarget,'/Granger_causality_',group,'.csv',sep=''),row.names=1)

# selecting those that Granger cause the target variable
Granger_causal=rowSums(df_res[,x2_ind])
Granger_causal=Granger_causal[Granger_causal!=0]
# getting the lag orders
df_res=df_res[names(Granger_causal),]
max_nlags=max(Granger_causal)
Granger_causal=data.frame(Granger_causal)
colnames(Granger_causal)[1]='N sign. lags'
Granger_causal[,paste(1:max_nlags,'. lag',sep='')]=NA
for (i in 1:nrow(Granger_causal)){
        Granger_causal[i,2:(Granger_causal[i,1]+1)]=which(df_res[i,x2_ind]==T)
        }
write.csv(Granger_causal,paste(DirTarget,'/Granger_causal_models_',group,'.csv',sep=''))
```
Forecast experiment
```{r, }

```


